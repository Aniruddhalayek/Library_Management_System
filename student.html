<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Student Portal - Library Management System</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Student Portal</h1>
      </header>

      <main id="app">
        <!-- Student Dashboard -->
        <section id="student-dash" class="hidden">
          <div class="student-header">
            
            <div class="student-actions">
              <button id="backToHomeBtn" class="secondary">üè† Back to Home</button>
              <button id="studentLogoutBtn">Logout</button>
            </div>
          </div>

          <!-- Student Quick Actions -->
          <div class="student-quick-actions">
            <div class="action-card" onclick="showStudentBooks()">
              <div class="action-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <h3>Browse Books</h3>
              
            </div>

            <div class="action-card" onclick="showStudentAccount()">
              <div class="action-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              </div>
              <h3>My Account</h3>
              
            </div>

            <div class="action-card" onclick="showStudentBorrowed()">
              <div class="action-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
              </div>
              <h3>My Books</h3>
              
            </div>

            <div class="action-card" onclick="showLibraryCard()">
              <div class="action-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                  </svg>
              </div>
              <h3>Library Card</h3>
              
            </div>

            <div class="action-card" onclick="showBookRequest()">
                <div class="action-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                    </svg>
                </div>
                <h3>Request a Book</h3>
                <p>Request a new book for the library</p>
            </div>
          </div>

          <!-- Student Book Search Section -->
          <section id="student-books" class="student-section">
            <div class="card">
              <h3>üìö Book Search</h3>
              <div class="search-container">
                <input id="studentBookSearch" placeholder="Search by title, author, or subject..." />
                <button id="studentSearchBtn" onclick="searchStudentBooks()">Search</button>
              </div>
              <div id="studentBooksList" class="books-grid"></div>
            </div>
          </section>

          <!-- Student Account Section -->
          <section id="student-account" class="student-section hidden">
            <div class="card">
              <h3>üë§ My Account</h3>
              <div class="account-info">
                <div class="info-item">
                  <label>Full Name:</label>
                  <span id="accountName">Student User</span>
                </div>
                <div class="info-item">
                  <label>Student ID:</label>
                  <span id="accountId">STU001</span>
                </div>
                <div class="info-item">
                  <label>Email:</label>
                  <span id="accountEmail">student@university.edu</span>
                </div>
                <div class="info-item">
                  <label>Department:</label>
                  <span id="accountDept">Computer Science</span>
                </div>
                <div class="info-item">
                  <label>Books Borrowed:</label>
                  <span id="accountBorrowed">0</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Student Borrowed Books Section -->
          <section id="student-borrowed" class="student-section hidden">
            <div class="card">
              <h3>üìñ My Borrowed Books</h3>
              <div id="studentBorrowedList" class="borrowed-list"></div>
            </div>
          </section>

          <!-- Library Card Section -->
          <section id="library-card" class="student-section hidden">
              <div class="card">
                  <h3>üí≥ Library Card</h3>
                  <div class="library-card-container">
                      <div class="library-card">
                          <div class="library-card-header">
                              <h4>Library Card</h4>
                              <p>University Library</p>
                          </div>
                          <div class="library-card-body">
                              <p><strong>Name:</strong> <span id="cardName"></span></p>
                              <p><strong>Student ID:</strong> <span id="cardStudentId"></span></p>
                              <p><strong>Department:</strong> <span id="cardDept"></span></p>
                          </div>
                      </div>
                  </div>
              </div>
          </section>

          <!-- Book Request Section -->
          <section id="book-request" class="student-section hidden">
              <div class="card">
                  <h3>üìù Book Request</h3>
                  <form id="bookRequestForm" class="modern-form">
                      <div class="form-row">
                          <div class="form-group">
                              <label for="requestAuthor">Author Name</label>
                              <input type="text" id="requestAuthor" placeholder="e.g. Robert C. Martin" required>
                          </div>
                          <div class="form-group">
                              <label for="requestTopic">Topic Name</label>
                              <input type="text" id="requestTopic" placeholder="e.g. Clean Code / Software Craftsmanship" required>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="requestDetails">Details (optional)</label>
                          <textarea id="requestDetails" rows="4" placeholder="Add ISBN, edition, publisher, or any notes..."></textarea>
                      </div>
                      <div class="form-actions">
                          <button type="reset" class="secondary">Clear</button>
                          <button type="submit">Submit Request</button>
                      </div>
                  </form>
              </div>
          </section>
        </section>
      </main>
    </div>

    <!-- Hidden file input for data import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;" />
    
    <script src="app.js"></script>
    <script src="global-buttons.js"></script>
    <script>
      // Safe helpers that don't break if app.js functions are missing
      function safeHideAllStudentSections() {
        if (typeof window.hideAllStudentSections === 'function') {
          try { window.hideAllStudentSections(); return; } catch (e) {}
        }
        // Fallback: hide all student sections locally
        document.querySelectorAll('.student-section').forEach(el => el.classList.add('hidden'));
      }

      function safeShowPopup(message) {
        if (typeof window.showPopup === 'function') {
          try { window.showPopup(message); return; } catch (e) {}
        }
        alert(message);
      }

      // Load student data from localStorage and wire up UI when page loads
      document.addEventListener("DOMContentLoaded", () => {
        // Wire up buttons first so they work even if something else errors later
        const backBtn = document.getElementById("backToHomeBtn");
        if (backBtn) {
          backBtn.addEventListener("click", () => { window.location.href = "./index.html"; });
        }

        const logoutBtn = document.getElementById("studentLogoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            try { localStorage.removeItem("lms_current_student"); } catch (e) {}
            window.location.href = "./student-login.html";
          });
        }

        const requestForm = document.getElementById("bookRequestForm");
        if (requestForm) {
          requestForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const author = (document.getElementById("requestAuthor").value || "").trim();
            const topic = (document.getElementById("requestTopic").value || "").trim();
            const details = (document.getElementById("requestDetails").value || "").trim();
            safeShowPopup(`Book request submitted: ${author ? author + " - " : ""}${topic}`);
            document.getElementById("requestAuthor").value = "";
            document.getElementById("requestTopic").value = "";
            document.getElementById("requestDetails").value = "";
          });
        }

        // Now handle session/dashboard logic
        const storedStudent = localStorage.getItem("lms_current_student");
        if (!storedStudent) {
          // If no student data, redirect to login page
          window.location.href = "./student-login.html";
          return;
        }

        try {
          window.currentUser = JSON.parse(storedStudent);
        } catch (e) {
          // Bad session data ‚Äî clear and redirect
          try { localStorage.removeItem("lms_current_student"); } catch (_) {}
          window.location.href = "./student-login.html";
          return;
        }

        // Try to show dashboard via app.js. If unavailable, unhide the section directly.
        if (typeof window.showStudentDashboard === 'function') {
          try {
            window.showStudentDashboard();
          } catch (e) {
            const dash = document.getElementById("student-dash");
            if (dash) dash.classList.remove("hidden");
          }
        } else {
          const dash = document.getElementById("student-dash");
          if (dash) dash.classList.remove("hidden");
        }
      });

      function showLibraryCard() {
        safeHideAllStudentSections();
        const section = document.getElementById("library-card");
        section.classList.remove("hidden");
        const studentData = JSON.parse(localStorage.getItem("lms_current_student"));
        document.getElementById("cardName").textContent = studentData.fullname;
        document.getElementById("cardStudentId").textContent = studentData.studentId;
        document.getElementById("cardDept").textContent = studentData.department;
        section.scrollIntoView({ behavior: 'smooth' });
      }

      function showBookRequest() {
        safeHideAllStudentSections();
        const section = document.getElementById("book-request");
        section.classList.remove("hidden");
        section.scrollIntoView({ behavior: 'smooth' });
      }
    </script>
  </body>
</html>
